<!doctype html>
<html lang="en">
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5899C1DJM0"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="apple-touch-icon" sizes="57x57" href="assets/apple-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="assets/apple-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="assets/apple-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="assets/apple-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="assets/apple-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="assets/apple-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="assets/apple-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="assets/apple-icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-icon-180x180.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="assets/android-icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="assets/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png" />
    <link rel="manifest" href="assets/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="assets/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />
    <title>Marble Roulette</title>
    <style lang="scss">
      * {
        box-sizing: border-box;
      }

      canvas {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
      }

      div.copyright {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 12px;
        z-index: 999;
        width: 90%;
        text-align: center;
      }

      div.copyright a {
        color: white;
      }

      #settings {
        position: fixed;
        bottom: 1rem;
        left: 1rem;
        background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(50, 50, 50, 0.95));
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 20px;
        z-index: 999;
        min-width: 400px;
        max-width: 500px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);

        display: flex;
        flex-direction: column;
        gap: 16px;
        visibility: visible;
        opacity: 1;
        transition:
          visibility 0s,
          opacity 0.3s ease;

        &.hide {
          opacity: 0;
          visibility: hidden;
        }

        h3 {
          padding: 0;
          margin: 0 0 12px 0;
          font-size: 16px;
          font-weight: 600;
          color: #ffffff;
          text-align: center;
          letter-spacing: 0.5px;
        }

        textarea {
          width: 100%;
          min-height: 80px;
          border: none;
          background: rgba(255, 255, 255, 0.08);
          border-radius: 8px;
          padding: 12px;
          font-size: 14px;
          color: #ffffff;
          resize: vertical;
          transition: background 0.2s ease;

          &:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
          }

          &::placeholder {
            color: rgba(255, 255, 255, 0.5);
          }
        }

        button {
          color: #ffffff;
          background: linear-gradient(135deg, #3b82f6, #1d4ed8);
          border: none;
          border-radius: 8px;
          padding: 8px 16px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          gap: 6px;

          &:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
          }

          &:active {
            transform: translateY(0);
          }
        }

        .icon {
          background: currentColor;
          mask-repeat: no-repeat;
          mask-position: center center;
          mask-size: contain;
          display: inline-block;
          width: 18px;
          height: 18px;
          vertical-align: middle;

          &.play {
            mask-image: url('assets/images/play.svg');
          }

          &.shuffle {
            mask-image: url('assets/images/shuffle.svg');
          }
          &.megaphone {
            mask-image: url('assets/images/megaphone.svg');
          }

          &.record {
            mask-image: url('assets/images/record.svg');
          }

          &.map {
            mask-image: url('assets/images/map.svg');
          }

          &.trophy {
            mask-image: url('assets/images/trophy.svg');
          }

          &.bomb {
            mask-image: url('assets/images/bomb.svg');
          }

          &.refresh {
            mask-image: url('assets/images/refresh.svg');
          }

          &.clock {
            mask-image: url('assets/images/clock.svg');
          }
        }

        .settings-grid {
          display: grid;
          grid-template-columns: 1fr;
          gap: 16px;
          margin-bottom: 16px;
        }

        .setting-item {
          display: flex;
          flex-direction: column;
          gap: 8px;

          label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 500;
            margin: 0;
            white-space: nowrap;
            margin-bottom: 8px;
          }

          .icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
          }
        }

        .setting-item.full-width {
          grid-column: 1 / -1;
        }

        .actions {
          display: flex;
          gap: 8px;

          button {
            flex: 1;
            justify-content: center;
          }

          #btnNotice {
            flex: 0 0 auto;
            width: 40px;
            background: rgba(255, 255, 255, 0.1);

            &:hover {
              background: rgba(255, 255, 255, 0.2);
            }
          }
        }

        select {
          width: 100%;
          height: 36px;
          border: none;
          border-radius: 6px;
          background: rgba(255, 255, 255, 0.08);
          color: #ffffff;
          padding: 0 12px;
          font-size: 13px;
          cursor: pointer;
          transition: background 0.2s ease;

          &:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.12);
          }

          option {
            background: #2a2a2a;
            color: #ffffff;
          }
        }

        input[type='checkbox'] {
          width: 44px;
          height: 24px;
          position: relative;
          appearance: none;
          cursor: pointer;
          margin: 0;

          &:before {
            position: absolute;
            content: '';
            display: block;
            width: 44px;
            height: 24px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
            top: 0;
            left: 0;
          }

          &:after {
            position: absolute;
            top: 2px;
            left: 2px;
            content: '';
            border-radius: 10px;
            width: 20px;
            height: 20px;
            background: #ffffff;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
          }

          &:checked:after {
            transform: translateX(20px);
          }

          &:checked:before {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
          }
        }

        .btn-group {
          display: flex;
          border-radius: 6px;
          overflow: hidden;
          background: rgba(255, 255, 255, 0.08);
          height: 32px;
        }

        .btn-group > * {
          box-sizing: border-box;
          flex: 1;
          height: 32px;
          border: none;
          padding: 0 8px;
          background: transparent;
          color: rgba(255, 255, 255, 0.7);
          font-size: 11px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
          border-right: 1px solid rgba(255, 255, 255, 0.1);

          display: flex;
          align-items: center;
          justify-content: center;

          &:last-child {
            border-right: none;
          }

          &:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
          }
        }

        .btn-group > *.active {
          background: linear-gradient(135deg, #3b82f6, #1d4ed8);
          color: #ffffff;
        }

        .btn-group input[type='number'] {
          box-sizing: border-box;
          text-align: center;
          background: transparent;
          border: none;
          color: inherit;
          font-size: inherit;
          font-weight: inherit;
          width: 100%;

          &:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.1);
          }

          &::-webkit-outer-spin-button,
          &::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
          }

          &[type='number'] {
            -moz-appearance: textfield;
          }
        }
      }

      #notice {
        display: none;
        position: fixed;
        overflow: hidden;
        top: 50%;
        left: 50%;
        width: 500px;
        max-width: 90%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        border-radius: 30px;
        z-index: 1001;
        padding: 10px 10px;
        color: #333;
        flex-direction: column;

        h1 {
          background-color: #ffdd00;
          margin: -10px -10px 0 -10px;
          padding: 10px 5px 10px 0.5em;
          border-bottom: 1px solid #333;
          display: flex;
          align-items: center;
          &:before {
            content: '';
            display: inline-block;
            width: 1em;
            height: 1em;
            background-image: url('assets/images/megaphone.svg');
            background-size: contain;
            margin-right: 0.2em;
          }
        }

        div.notice-body {
          padding: 0 0.5em;
        }

        div.notice-action {
          display: flex;
          justify-content: end;

          button {
            color: #fefefe;
            background: #222;
            border: none;
            border-radius: 20px;
            padding: 5px 10px;
            position: relative;
            overflow: hidden;
            width: 50%;
            height: 50px;

            &:active:after {
              content: '';
              position: absolute;
              left: 0;
              top: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.5);
            }
          }
        }
      }

      #donate {
        position: fixed;
        bottom: calc(160px + 1.5rem);
        left: 1rem;
        z-index: 999;
        visibility: visible;
        opacity: 1;
        transition:
          visibility 0s,
          opacity 1s linear;

        &.hide {
          opacity: 0;
          visibility: hidden;
        }
      }

      @media screen and (max-width: 750px) {
        #donate {
          bottom: 2rem;
        }

        #settings {
          bottom: calc(2.5rem + 60px);
          left: 1rem;
          right: 1rem;
          min-width: 0;
          max-width: none;
          width: auto;
          padding: 16px;

          .settings-grid {
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 16px;
          }

          .setting-item {
            label {
              font-size: 14px;
              margin-bottom: 8px;
            }

            .icon {
              width: 16px;
              height: 16px;
            }
          }

          .btn-group {
            flex-wrap: wrap;
            height: auto;

            > * {
              flex: 1 1 calc(50% - 1px);
              min-width: 0;
              font-size: 10px;

              &:nth-child(1),
              &:nth-child(2) {
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
              }

              &:nth-child(1) {
                border-right: 1px solid rgba(255, 255, 255, 0.1);
              }

              &:nth-child(3),
              &:nth-child(4) {
                border-right: none;
              }
            }

            input[type='number'] {
              flex: 1 1 calc(50% - 1px);

              &:first-of-type {
                border-right: 1px solid rgba(255, 255, 255, 0.1);
              }
            }
          }

          .actions {
            flex-direction: column;
            gap: 8px;

            #btnNotice {
              width: 100%;
              flex: 1;
            }

            button {
              width: 100%;
            }
          }

          h3 {
            font-size: 15px;
            margin-bottom: 8px;
          }

          textarea {
            min-height: 60px;
            font-size: 13px;
          }
        }

        #notice {
          position: fixed;
          box-sizing: border-box;
          top: 0;
          left: 0;
          width: 100%;
          max-width: 100%;
          height: 100%;
          transform: none;
          background: rgba(255, 255, 255, 0.9);
          border-radius: 4px;
          z-index: 1001;
          padding: 5px 10px;
          color: #333;
          display: none;
          flex-direction: column;

          div.notice-body {
            flex-grow: 1;
          }
        }
      }

      #page_title {
        position: fixed;
        top: 1rem;
        left: 50%;
        width: 100%;
        height: 100px;
        z-index: 1000;
        color: white;
        transform: translateX(-50%);
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        text-align: center;
        line-height: 1.2;
        letter-spacing: 0.1em;
      }

      #inGame {
        position: fixed;
        bottom: 1rem;
        left: 1rem;
        background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(50, 50, 50, 0.95));
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 16px;
        z-index: 999;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);

        button {
          color: #ffffff;
          background: linear-gradient(135deg, #ef4444, #dc2626);
          border: none;
          border-radius: 8px;
          padding: 12px 24px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          text-transform: uppercase;
          letter-spacing: 0.5px;

          &:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
          }

          &:active {
            transform: translateY(0) scale(1);
          }
        }

        &.hide {
          opacity: 0;
          visibility: hidden;
        }
      }

      #countdown {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        visibility: visible;
        opacity: 1;
        transition: all 0.3s ease;

        &.hide {
          opacity: 0;
          visibility: hidden;
        }

        .countdown-content {
          text-align: center;
          color: white;
          animation: pulse 2s infinite;
          display: flex;
          flex-direction: column;
          gap: 40px;
          max-width: 600px;
          margin: 0 auto;

          h2 {
            font-size: 1.5rem;
            font-weight: 500;
            margin: 0 0 20px 0;
            color: rgba(255, 255, 255, 0.9);
          }

          .game-result {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);

            .winners-list {
              display: flex;
              flex-wrap: wrap;
              justify-content: center;
              gap: 12px;
              margin-top: 10px;

              .winner-item {
                background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 237, 78, 0.2));
                border: 2px solid rgba(255, 215, 0, 0.5);
                border-radius: 12px;
                padding: 12px 16px;
                display: flex;
                align-items: center;
                gap: 8px;
                backdrop-filter: blur(10px);

                .rank {
                  background: linear-gradient(135deg, #ffd700, #ffed4e);
                  color: #000;
                  font-weight: bold;
                  font-size: 1.2rem;
                  width: 30px;
                  height: 30px;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  flex-shrink: 0;
                }

                .name {
                  color: #ffffff;
                  font-weight: 600;
                  font-size: 1.3rem;
                  text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
                }
              }
            }
          }

          .next-game {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
          }

          .countdown-number {
            font-size: 6rem;
            font-weight: bold;
            margin: 20px 0;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
            animation: countdownPulse 1s ease-in-out;
          }

          .countdown-subtext {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 20px;
          }
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      @keyframes countdownPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body>
    <h1 id="page_title">지니배 운명의 치규 레이싱</h1>
    <script type="module" src="./src/index.ts"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }

      gtag('js', new Date());
      gtag('config', 'G-5899C1DJM0');

      function getNames() {
        const value = document.querySelector('#in_names').value.trim();
        return value
          .split(/[,\r\n]/g)
          .map((v) => v.trim())
          .filter((v) => !!v);
      }

      function parseName(nameStr) {
        const weightRegex = /(\/\d+)/;
        const countRegex = /(\*\d+)/;
        const hasWeight = weightRegex.test(nameStr);
        const hasCount = countRegex.test(nameStr);
        const name = /^\s*([^\/*]+)?/.exec(nameStr)[1];
        const weight = hasWeight ? parseInt(weightRegex.exec(nameStr)[1].replace('/', '')) : 1;
        const count = hasCount ? parseInt(countRegex.exec(nameStr)[1].replace('*', '')) : 1;
        return {
          name,
          weight,
          count,
        };
      }

      function getReady() {
        const names = getNames();
        window.roullete.setMarbles(names);
        ready = names.length > 0;
        localStorage.setItem('mbr_names', names.join(','));
        switch (winnerType) {
          case 'first':
            setWinnerRank(1);
            break;
          case 'last':
            const total = window.roullete.getCount();
            setWinnerRank(total);
            break;
        }
      }

      function setWinnerRank(rank) {
        document.querySelector('#in_winningRank').value = rank;
        window.options.winningRank = rank - 1;
        window.roullete.setWinningRank(window.options.winningRank);

        if (winnerType === 'first') {
          document.querySelector('.btn-first-winner').classList.toggle('active', true);
          document.querySelector('.btn-last-winner').classList.toggle('active', false);
          document.querySelector('#in_winningRank').classList.toggle('active', false);
          document.querySelector('#in_winningRange').classList.toggle('active', false);
        } else if (winnerType === 'last') {
          document.querySelector('.btn-first-winner').classList.toggle('active', false);
          document.querySelector('.btn-last-winner').classList.toggle('active', true);
          document.querySelector('#in_winningRank').classList.toggle('active', false);
          document.querySelector('#in_winningRange').classList.toggle('active', false);
        } else if (winnerType === 'custom') {
          document.querySelector('.btn-first-winner').classList.toggle('active', false);
          document.querySelector('.btn-last-winner').classList.toggle('active', false);
          document.querySelector('#in_winningRank').classList.toggle('active', true);
          document.querySelector('#in_winningRange').classList.toggle('active', false);
        } else if (winnerType === 'range') {
          document.querySelector('.btn-first-winner').classList.toggle('active', false);
          document.querySelector('.btn-last-winner').classList.toggle('active', false);
          document.querySelector('#in_winningRank').classList.toggle('active', false);
          document.querySelector('#in_winningRange').classList.toggle('active', true);
        }
      }

      function setWinnerRange(range) {
        document.querySelector('#in_winningRange').value = range;
        window.options.winningRange = range;
        window.roullete.setWinningRange(window.options.winningRange);
        winnerType = 'range';
        setWinnerRank(1); // range 모드에서는 rank는 의미가 없지만 UI 업데이트를 위해 호출
      }

      let ready = false;
      let winnerType = 'first';

      document.addEventListener('DOMContentLoaded', () => {
        initialize();
      });

      function initialize() {
        if (!window.roullete || !window.roullete.isReady) {
          console.log('does not loaded yet');
          setTimeout(initialize, 100);
          return;
        }
        console.log('initializing start');

        const savedNames = localStorage.getItem('mbr_names');
        if (savedNames) {
          document.querySelector('#in_names').value = savedNames;
        }
        document.querySelector('#in_names').addEventListener('input', () => {
          getReady();
        });

        document.querySelector('#in_names').addEventListener('blur', () => {
          const nameSource = getNames();
          const nameSet = new Set();
          const nameCounts = {};
          nameSource.forEach((nameSrc) => {
            const name = parseName(nameSrc);
            const key = name.weight > 1 ? `${name.name}/${name.weight}` : name.name;
            if (!nameSet.has(key)) {
              nameSet.add(key);
              nameCounts[key] = 0;
            }
            nameCounts[key] += name.count;
          });
          const result = [];
          Object.keys(nameCounts).forEach((key) => {
            if (nameCounts[key] > 1) {
              result.push(`${key}*${nameCounts[key]}`);
            } else {
              result.push(key);
            }
          });

          const oldValue = document.querySelector('#in_names').value;
          const newValue = result.join(',');

          if (oldValue !== newValue) {
            document.querySelector('#in_names').value = newValue;
            getReady();
          }
        });

        document.querySelector('#btnShuffle').addEventListener('click', () => {
          getReady();
        });

        document.querySelector('#btnStart').addEventListener('click', () => {
          if (!ready) return;
          gtag &&
            gtag('event', 'start', {
              event_category: 'roulette',
              event_label: 'start',
              value: window.roullete.getCount(),
            });
          window.roullete.start();
          document.querySelector('#settings').classList.add('hide');
          document.querySelector('#donate').classList.add('hide');
        });

        document.querySelector('#chkAutoRecording').addEventListener('change', (e) => {
          window.options.autoRecording = e.target.matches(':checked');
          window.roullete.setAutoRecording(window.options.autoRecording);
        });

        document.querySelector('#chkSkill').addEventListener('change', (e) => {
          window.options.useSkills = e.target.matches(':checked');
          window.roullete.setWinningRank(window.options.winningRank);
        });

        document.querySelector('#chkInfiniteLoop').addEventListener('change', (e) => {
          window.options.infiniteLoop = e.target.matches(':checked');
          window.roullete.setInfiniteLoop(window.options.infiniteLoop);
        });

        document.querySelector('#inLoopDelay').addEventListener('change', (e) => {
          const delay = parseInt(e.target.value, 10) * 1000; // convert to milliseconds
          window.options.loopDelay = delay;
          window.roullete.setLoopDelay(delay);
        });

        document.querySelector('#in_winningRank').addEventListener('change', (e) => {
          const v = parseInt(e.target.value, 10);
          winnerType = 'custom';
          setWinnerRank(isNaN(v) ? 0 : v);
        });

        document.querySelector('#in_winningRange').addEventListener('change', (e) => {
          const v = parseInt(e.target.value, 10);
          setWinnerRange(isNaN(v) ? 1 : v);
        });

        document.querySelector('.btn-last-winner').addEventListener('click', () => {
          const total = window.roullete.getCount();
          winnerType = 'last';
          setWinnerRank(total);
        });
        document.querySelector('.btn-first-winner').addEventListener('click', () => {
          winnerType = 'first';
          setWinnerRank(1);
        });

        document.querySelector('#btnShake').addEventListener('click', () => {
          window.roullete.shake();
          gtag('event', 'shake', {
            event_category: 'roulette',
            event_label: 'shake',
            value: 1,
          });
        });

        window.roullete.addEventListener('goal', () => {
          ready = false;
          if (!window.options.infiniteLoop) {
            setTimeout(() => {
              document.querySelector('#settings').classList.remove('hide');
              document.querySelector('#donate').classList.remove('hide');
            }, 3000);
          }
        });
        window.roullete.addEventListener('shakeAvailableChanged', (e) => {
          document.querySelector('#inGame').classList.toggle('hide', !e.detail);
        });

        window.roullete.addEventListener('hideUI', () => {
          document.querySelector('#settings').classList.add('hide');
          document.querySelector('#donate').classList.add('hide');
        });

        window.roullete.addEventListener('showUI', () => {
          document.querySelector('#settings').classList.remove('hide');
          document.querySelector('#donate').classList.remove('hide');
          document.querySelector('#chkInfiniteLoop').checked = false;
          window.options.infiniteLoop = false;
        });

        // ESC 키로 무한 반복 중단
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && window.options.infiniteLoop) {
            window.roullete.stopInfiniteLoop();
          }
        });

        // 카운트다운 관련 이벤트 처리
        let countdownInterval = null;

        window.roullete.addEventListener('startCountdown', (e) => {
          const totalSeconds = e.detail.seconds;
          const winners = e.detail.winners;
          const isMultipleWinners = e.detail.isMultipleWinners;
          let remainingSeconds = totalSeconds;

          // 승자 목록 표시
          const winnersList = document.querySelector('#countdown .winners-list');
          winnersList.innerHTML = '';

          if (winners && winners.length > 0) {
            winners.forEach((winner) => {
              const winnerItem = document.createElement('div');
              winnerItem.className = 'winner-item';
              winnerItem.innerHTML = `
                <div class="rank">${winner.rank}</div>
                <div class="name">${winner.name}</div>
              `;
              winnersList.appendChild(winnerItem);
            });
          } else {
            winnersList.innerHTML = '<div class="no-winner">승자가 없습니다</div>';
          }

          document.querySelector('#countdown').classList.remove('hide');
          document.querySelector('#countdown .countdown-number').textContent = remainingSeconds;

          countdownInterval = setInterval(() => {
            remainingSeconds--;
            document.querySelector('#countdown .countdown-number').textContent = remainingSeconds;

            // 숫자가 바뀔 때 애니메이션 재시작
            const numberElement = document.querySelector('#countdown .countdown-number');
            numberElement.style.animation = 'none';
            setTimeout(() => {
              numberElement.style.animation = 'countdownPulse 1s ease-in-out';
            }, 10);

            if (remainingSeconds <= 0) {
              clearInterval(countdownInterval);
              document.querySelector('#countdown').classList.add('hide');
            }
          }, 1000);
        });

        window.roullete.addEventListener('hideCountdown', () => {
          if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
          }
          document.querySelector('#countdown').classList.add('hide');
        });

        document.querySelector('#btnShuffle').click();

        const maps = window.roullete.getMaps();
        const mapSelector = document.querySelector('#sltMap');
        maps.forEach((map) => {
          const option = document.createElement('option');
          option.value = map.index;
          option.innerHTML = map.title;
          option.setAttribute('data-trans', '');
          window.translateElement(option);
          mapSelector.append(option);
        });
        mapSelector.addEventListener('change', (e) => {
          const index = e.target.value;
          window.roullete.setMap(index);
        });

        const checkDonateButtonLoaded = () => {
          const btn = document.querySelector('span.bmc-btn-text');
          if (!btn) {
            setTimeout(checkDonateButtonLoaded, 100);
          } else {
            console.log('donation button has been loaded');
            btn.setAttribute('data-trans', '');
            window.translateElement(btn);
          }
        };
        setTimeout(checkDonateButtonLoaded, 100);

        const currentNotice = 1;
        const noticeKey = 'lastViewedNotification';

        const closeNotice = () => {
          document.querySelector('#notice').style.display = 'none';
          localStorage.setItem(noticeKey, currentNotice.toString());
        };

        const openNotice = () => {
          console.log('openNotice');
          document.querySelector('#notice').style.display = 'flex';
        };

        document.querySelector('#closeNotice').addEventListener('click', () => {
          closeNotice();
        });

        document.querySelector('#btnNotice').addEventListener('click', () => {
          openNotice();
        });

        const checkNotice = () => {
          const lastViewed = localStorage.getItem(noticeKey);
          console.log('lastViewed', lastViewed);
          if (lastViewed === null || Number(lastViewed) < currentNotice) {
            openNotice();
          }
        };

        checkNotice();
      }
    </script>
    <div id="settings" class="settings">
      <div class="left">
        <h3 data-trans>Enter names below</h3>
        <textarea
          id="in_names"
          placeholder="Input names separated by commas or line feed here"
          data-trans="placeholder"
        >
짱구*5, 짱아*10, 봉미선*3</textarea
        >
        <div class="actions">
          <button id="btnNotice">
            <i class="icon megaphone"></i>
          </button>
          <button id="btnShuffle">
            <i class="icon shuffle"></i>
            <span data-trans>Shuffle</span>
          </button>
          <button id="btnStart">
            <i class="icon play"></i>
            <span data-trans>Start</span>
          </button>
        </div>
      </div>

      <div class="settings-grid">
        <div class="setting-item">
          <label>
            <i class="icon map"></i>
            <span data-trans>Map</span>
          </label>
          <select id="sltMap"></select>
        </div>

        <div class="setting-item">
          <label>
            <i class="icon record"></i>
            <span data-trans>Recording</span>
          </label>
          <input type="checkbox" id="chkAutoRecording" />
        </div>

        <div class="setting-item">
          <label>
            <i class="icon bomb"></i>
            <span data-trans>Using skills</span>
          </label>
          <input type="checkbox" id="chkSkill" checked />
        </div>

        <div class="setting-item">
          <label>
            <i class="icon refresh"></i>
            <span data-trans>Infinite Loop</span>
          </label>
          <input type="checkbox" id="chkInfiniteLoop" />
        </div>

        <div class="setting-item">
          <label>
            <i class="icon clock"></i>
            <span data-trans>Loop Delay (seconds)</span>
          </label>
          <input
            type="number"
            id="inLoopDelay"
            value="5"
            min="1"
            max="60"
            style="
              width: 100%;
              height: 36px;
              border: none;
              border-radius: 6px;
              background: rgba(255, 255, 255, 0.08);
              color: #ffffff;
              padding: 0 12px;
              font-size: 13px;
            "
          />
        </div>

        <div class="setting-item">
          <label>
            <i class="icon trophy"></i>
            <span data-trans>The winner is</span>
          </label>
          <div class="btn-group">
            <button class="btn-winner btn-first-winner active" data-trans>First</button>
            <button class="btn-winner btn-last-winner" data-trans>Last</button>
            <input type="number" id="in_winningRank" value="1" min="1" />
            <input type="number" id="in_winningRange" value="1" min="1" />
          </div>
        </div>
      </div>
    </div>
    <div id="inGame" class="settings hide">
      <button id="btnShake" data-trans>Shake!</button>
    </div>

    <div id="countdown" class="countdown hide">
      <div class="countdown-content">
        <div class="game-result">
          <h2 data-trans>🎉 게임 결과</h2>
          <div class="winners-list">
            <!-- 승자들이 여기에 동적으로 추가됩니다 -->
          </div>
        </div>

        <div class="next-game">
          <h2 data-trans>다음 게임 시작까지</h2>
          <div class="countdown-number">5</div>
          <div class="countdown-subtext">
            <span data-trans>ESC 키를 눌러 중단</span>
          </div>
        </div>
      </div>
    </div>

    <div id="notice">
      <h1>Notice</h1>
      <div class="notice-body">
        <p>이 프로그램은 무료이며 사용에 아무런 제한이 없습니다.</p>
        <p>
          이 프로그램의 사용이나 프로그램을 이용한 영상 제작, 방송 등에 원작자는 아무런 제재를 가하거나 이의를 제기하지
          않습니다. 자유롭게 사용하셔도 됩니다.
        </p>
        <p>다만 저작권자를 사칭하는 것은 저작권법을 위반하는 범죄입니다.</p>
        <p>
          저작권자를 사칭하여 권리 침해를 주장하는 경우를 보거나 겪으시는 분은
          <a href="mailto:lazygyu+legal@gmail.com" target="_blank">lazygyu+legal@gmail.com</a> 으로 제보 부탁드립니다.
        </p>
        <p>감사합니다.</p>
      </div>
      <div class="notice-action">
        <button id="closeNotice" data-trans>Close</button>
      </div>
    </div>

    <div class="copyright">
      &copy; 2025.<a href="https://lazygyu.net" target="_blank">lazygyu</a>
      <span data-trans
        >This program is freeware and may be used freely anywhere, including in broadcasts and videos.</span
      >
    </div>
  </body>
</html>
